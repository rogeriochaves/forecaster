import db
import pandas as pd
from yyyy_mm_dd import *

stds = {
    'Amsterdam': [0.19660064200323854, 0.2383552612223972, 0.24637917559070285, 0.2567377666273462, 0.2769345820649991, 0.25988795411934534, 0.2591418181970274, 0.2600691186768337, 0.26349445716168757, 0.2609331590767258, 0.26471109387051434, 0.2632894521789452, 0.2664901882334896, 0.2716871438013777, 0.2761305425003428, 0.2792497015187846, 0.2748464079452215, 0.2773755833560155, 0.2802023041210639, 0.28170403379954745, 0.28079213172340817, 0.28457807195483986, 0.29317417417635955, 0.29012371907354734, 0.2895611924361685, 0.2851722890963348, 0.2853692667424292, 0.28655691401895894, 0.29096525041866333, 0.29532291222576673, 0.30048861933874543, 0.29785852898074516, 0.2986015062933946, 0.2968000389931035, 0.29275546670577374, 0.2947239615901258, 0.30026705766973133, 0.3056589781873982, 0.3029437702556515, 0.30068563531702297, 0.3009011511906223, 0.30469307134998647, 0.299926244343794, 0.29192349828158914, 0.29297914307173195, 0.2904939589984911, 0.2969487842963446, 0.4392106721796901],
    'Rio de Janeiro': [0.047516448721903116, 0.0691692079040573, 0.08653805347981429, 0.10847364896060305, 0.12320037630092069, 0.1274704358828662, 0.154884148535676, 0.1575432022446098, 0.15660622988775713, 0.1576198151912777, 0.1619820032610724, 0.16214882522486612, 0.16269854063610603, 0.16338163383032514, 0.16444518146326423, 0.16140555232148884, 0.16063792418487738, 0.16324002796273862, 0.16658410506816432, 0.16517079998536555, 0.16711289602507337, 0.16922039084334678, 0.1704589338679017, 0.17085556126702076, 0.16730265168828884, 0.16703154084714095, 0.16625825868999594, 0.16406387528794086, 0.166249545521256, 0.16777455800749694, 0.17053978909383294, 0.1744050025960669, 0.1743879106817563, 0.171943079665187, 0.1713514730975283, 0.17491596393724035, 0.17836590797383942, 0.18104733199644482, 0.18153817528664623, 0.18345226629885036, 0.18376067244327532, 0.18298264240469791, 0.1861959978329796, 0.18776081810958783, 0.19343983206266643, 0.1964207284997987, 0.198598472912617, 0.4993764543424647],
    'Cairo': [0.0063660493028720655, 0.005480871675528089, 0.005024994820600314, 0.006904987847355167, 0.007456076542054227, 0.012417352940959837, 0.016967643443998766, 0.018799358221492937, 0.021025405468246595, 0.022518149675871194, 0.02314019218922396, 0.023312056457799962, 0.022276314035186734, 0.022733263582065587, 0.02225969866769388, 0.022437107010817657, 0.021252372288919463, 0.021594976027432124, 0.021123005585709387, 0.01829723526801311, 0.01467965852037427, 0.014796555344435578, 0.015205056376520245, 0.014965288467579057, 0.014928723579624303, 0.014881939633689069, 0.013982025146309376, 0.014263427505762618, 0.015008968725709917, 0.015250881417507465, 0.01687115971208515, 0.018236240528959887, 0.017450332348097092, 0.01728552034721729, 0.01569527845900537, 0.016219110829392397, 0.017022141399534632, 0.01816040140584967, 0.015912224912408117, 0.015053521089824929, 0.014851327415358566, 0.014741212924572046, 0.01268315873464211, 0.011634585800562923, 0.01423487609403747, 0.015653720581615044, 0.014742149465160071, 2.389739186831967e-103],
    'Barra Mansa': [0.022492620121298296, 0.03210213563522685, 0.0488080495050118, 0.059449486094074584, 0.06438469189512, 0.09620512558807516, 0.14978504261457096, 0.15041539519784702, 0.15065982044202708, 0.15204667011229037, 0.15244451281711685, 0.15377190398681623, 0.15481441894798595, 0.15571043058978293, 0.1563646488181894, 0.15721986381425865, 0.15708380847686, 0.1557870615073598, 0.15279212012627807, 0.1475801770190389, 0.1434631999618406, 0.14033291390303912, 0.13917784002119005, 0.13770816119846416, 0.1388456802872397, 0.14002242348108582, 0.14168958040610052, 0.14493374454726227, 0.14555430767080044, 0.14840822269500792, 0.14805240495730715, 0.14986245665160505, 0.1515332937153347, 0.15007567728854806, 0.1466908990817074, 0.14628927458834823, 0.14528785241563902, 0.14598426632740025, 0.14303764929685467, 0.14333669321463532, 0.1426374090899802, 0.1430228239062041, 0.14524668855441333, 0.14486521422877302, 0.1449513494266382, 0.14606144657767278, 0.1472725707209246, 0.17273846054704683],
    'Porto Alegre': [0.061010094360997066, 0.049136943018347055, 0.05735402055371461, 0.05745532524569865, 0.06352718875189343, 0.06680363016258582, 0.08376516280956595, 0.08394821328068647, 0.08463541918885881, 0.08645385559860873, 0.08902747355813048, 0.08777290369877608, 0.0890130155308998, 0.08757935484762092, 0.08840984198603127, 0.08774122200520636, 0.08945826446690211, 0.08925553613311447, 0.09202045746280382, 0.0979023640366891, 0.1048069375726853, 0.10186626550797218, 0.10955235335484229, 0.10540769269206317, 0.10908746263552202, 0.11053372619588259, 0.11856245582390847, 0.11991611028538374, 0.12164250513389377, 0.12187858124027175, 0.1230849546748919, 0.12322610717944199, 0.11963829925356821, 0.11802795845521494, 0.11710699718236321, 0.12260171000008971, 0.11894572666294644, 0.12496477143717434, 0.12553650514513237, 0.12641559652659815, 0.1257861276049466, 0.13240157799702684, 0.13277668076575314, 0.1317487110660167, 0.13548712843939412, 0.13459017929934922, 0.13315146853567733, 0.09919149807516771]
}


def predictions_for(city):
    df = get_data(city)
    forecasts = {}
    for _, row in df.sort_values(by=['timestamp', 'forecast_delta'], ascending=False).iterrows():
        if len(forecasts.values()) >= 48:
            break
        if row.forecast_delta not in forecasts:
            forecasts[row.forecast_delta] = row
    forecasts = [adjust_forecast(city, df, row) for row in forecasts.values()]
    forecasts = sorted(forecasts, key=lambda x: x["forecast_for"])

    return forecasts


def adjust_forecast(city, df, row):
    df = df[(df.forecast_delta == row.forecast_delta)]
    prediction = row.weather_type

    len_df = len(df)
    p_prediction = len(df[df.weather_type == prediction]) / len_df

    probabilities = {}
    for weather in df.weather_type.cat.categories:
        df_weather = df[df.weather_type_actual == weather]
        p_weather = len(df_weather) / len_df
        if p_weather == 0:
            continue

        p_prediction_given_weather = len(
            df_weather[df_weather.weather_type == prediction]) / len(df_weather)

        p_weather_given_prediction = (
            p_prediction_given_weather * p_weather) / p_prediction

        group = weather_group(weather)
        probabilities[group] = \
            probabilities.get(group, 0) + p_weather_given_prediction

    probabilities = [{
        'weather': key,
        'chance': round(100 * chance)
    } for key, chance in probabilities.items() if chance > 0.01]

    probabilities = sorted(
        probabilities, key=lambda x: x["chance"], reverse=True)

    return {
        'forecast_for': row.forecast_for,
        'probabilities': probabilities,
        'precipitation': {
            'mu': row.precipitation / 100,
            'sigma': stds[city][row.forecast_delta]
        }
    }


def weather_group(weather):
    if 'Sunny' in weather:
        return 'Sunny'
    elif 'Clear' in weather:
        return 'Clear'
    elif 'Cloudy' in weather:
        return 'Cloudy'
    elif 'T-' in weather:
        return 'T-Storms'
    elif 'Showers' in weather:
        return 'Showers'
    elif 'Rain' in weather:
        return 'Rain'
    return weather


def get_data(city):
    columns = ["timestamp", "forecast_delta",
               "summary", "temperature", "precipitation"]
    conn = db.connect()
    cur = conn.cursor()
    cur.execute(
        "SELECT " +
        ", ".join(
            columns) + " FROM Forecasts WHERE type='hourly' AND city=%s;",
        (city,)
    )
    result = cur.fetchall()
    conn.close()

    return build_df(result, columns)


def build_df(data, columns):
    df = pd.DataFrame(data, columns=columns)
    df['timestamp'] = [start_of_yyyy_mm_dd_hh(
        timestamp) for timestamp in df['timestamp']]
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    df['forecast_for'] = [move_yyyy_mm_dd_hh(timestamp, delta)
                          for timestamp, delta in zip(df['timestamp'], df['forecast_delta'])]
    # TODO: care about the wind
    df['weather_type'] = pd.Series([summary.replace(
        " / Wind", "").strip() for summary in df['summary']]).astype("category")
    to_join = df[df.forecast_delta == 0].drop(columns=['forecast_for']).rename(
        columns={'timestamp': 'forecast_for'}).set_index(['forecast_for'])[['weather_type']].copy()
    df = df.join(
        to_join,
        on=['forecast_for'],
        how='left',
        rsuffix="_actual"
    )
    return df
